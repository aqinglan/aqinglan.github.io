<!DOCTYPE html><html lang="zh-CN, en-US"><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="IE=edge" http-equiv=X-UA-Compatible><title>12-并发编程 • Akiのink</title><link href=/favicon/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/favicon/favicon-32x32.png rel=icon type=image/png sizes=32x32><link href=/favicon/favicon-16x16.png rel=icon type=image/png sizes=16x16><link href=/favicon/site.webmanifest rel=manifest><link href=/fonts/Satoshi-Variable.ttf rel=preload type=font/ttf as=font crossorigin><link href=/fonts/Satoshi-VariableItalic.ttf rel=preload type=font/ttf as=font crossorigin><link href=https://astro-theme-pure.vercel.app/blog/12-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B rel=canonical><meta content="12-并发编程 • Akiのink" name=title><meta content="对应 CSAPP 第十二章节" name=description><meta content=Aki name=author><meta content="" name=theme-color><meta content=article property=og:type><meta content=12-并发编程 property=og:title><meta content="对应 CSAPP 第十二章节" property=og:description><meta content=https://astro-theme-pure.vercel.app/blog/12-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B property=og:url><meta content=Akiのink property=og:site_name><meta content=en_US property=og:locale><meta content=https://astro-theme-pure.vercel.app/_astro/12.BBeEy0zY.png property=og:image><meta content=1200 property=og:image:width><meta content=630 property=og:image:height><meta content=Aki property=article:author><meta content=2023-02-18T12:47:57.000Z property=article:published_time><meta content=summary_large_image property=twitter:card><meta content=https://astro-theme-pure.vercel.app/blog/12-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B property=twitter:url><meta content=12-并发编程 property=twitter:title><meta content="对应 CSAPP 第十二章节" property=twitter:description><meta content=https://astro-theme-pure.vercel.app/_astro/12.BBeEy0zY.png property=twitter:image><meta content=@cworld0_cn name=telegram:channel><link href=/sitemap-index.xml rel=sitemap><link href=https://astro-theme-pure.vercel.app/rss.xml rel=alternate type=application/rss+xml title=Akiのink><meta content="Astro v4.16.10" name=generator><link href=/styles/global.css rel=stylesheet><vercel-speed-insights data-params={&#34;slug&#34;:&#34;12-并发编程&#34;} data-pathname=/blog/12-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B data-props={}></vercel-speed-insights><script>console.log("%c Astro Theme Pure %c https://github.com/cworld1/astro-theme-pure/","color:#fff;background:linear-gradient(90deg,#448bff,#44e9ff);padding:5px 0;","color:#000;background:linear-gradient(90deg,#44e9ff,#ffffff);padding:5px 10px 5px 0px;")</script><link href=/_astro/_slug_.XaQ6XQsx.css rel=stylesheet><link href=/_astro/_slug_.BLJzc6jn.css rel=stylesheet><style>#waline[data-astro-cid-ksttp56e]{--waline-font-size:16px;--waline-white:hsl(var(--background) / var(--tw-bg-opacity));--waline-light-grey:#999;--waline-dark-grey:#666;--waline-theme-color:hsl(var(--foreground) / var(--tw-text-opacity));--waline-active-color:hsl(var(--primary) / var(--tw-text-opacity));--waline-color:hsl(var(--muted-foreground) / var(--tw-text-opacity));--waline-bg-color:hsl(var(--primary-foreground) / var(--tw-bg-opacity));--waline-bg-color-light:hsl(var(--input) / var(--tw-bg-opacity));--waline-bg-color-hover:#f0f0f0;--waline-border-color:hsl(var(--border) / var(--tw-border-opacity));--waline-disable-bg-color:#f8f8f8;--waline-disable-color:#bbb;--waline-code-bg-color:#282c34;--waline-bq-color:#f0f0f0;--waline-avatar-size:3.25rem;--waline-m-avatar-size:calc(var(--waline-avatar-size) * 9 / 13);--waline-badge-color:#3498db;--waline-badge-font-size:.775em;--waline-info-bg-color:var(--waline-bg-color-light);--waline-info-color:var(--waline-color);--waline-info-font-size:.625em;--waline-border:1px solid var(--waline-border-color);--waline-avatar-radius:50%;--waline-box-shadow:none}#waline[data-astro-cid-ksttp56e] .wl-reaction-title{display:none!important}#waline[data-astro-cid-ksttp56e] .wl-reaction{overflow:visible}#waline[data-astro-cid-ksttp56e] blockquote{position:relative;border-inline-start:4px solid transparent!important}#waline[data-astro-cid-ksttp56e] blockquote:before{content:"";height:100%;width:4px;left:-4px;top:0;position:absolute;border:2px solid var(--waline-bq-color)!important;border-radius:9999px}</style><link href=/_astro/_slug_.C639AhNv.css rel=stylesheet><script type=module src=/_astro/hoisted.B8nntUZK.js></script><script type=module src=/_astro/page.V2R8AmkL.js></script><script>window.va=window.va||function(){(window.vaq=window.vaq||[]).push(arguments)};var script=document.createElement("script");script.defer=!0,script.src="/_vercel/insights/script.js";var head=document.querySelector("head");head.appendChild(script)</script></head><body class="flex bg-background justify-center"><script>const lightModePref=window.matchMedia("(prefers-color-scheme: light)");function getUserPref(){return localStorage.getItem("theme")||(lightModePref.matches?"light":"dark")}function setTheme(e,t=!1){if(!["light","dark"].includes(e))return void console.log(`Invalid theme value '${e}' received. Expected 'light' or 'dark'.`);t&&localStorage.setItem("theme",e),document.documentElement.classList.toggle("dark","dark"===e);const r="dark"===e?"#0B0B10":"#FCFCFD";document.querySelector('meta[name="theme-color"]')?.setAttribute("content",r)}setTheme(getUserPref()),document.addEventListener("astro:after-swap",(()=>setTheme(getUserPref()))),document.addEventListener("theme-change",(e=>{const t=e.detail.theme;localStorage.setItem("theme",t),setTheme(e.detail.theme,!0)})),lightModePref.addEventListener("change",(e=>{setTheme(e.matches?"light":"dark")}))</script><main class="flex items-center flex-col leading-relaxed lg:px-10 max-w-[60rem] min-h-screen pb-10 px-4 sm:px-7 text-[0.92rem] w-screen z-10"><header-component class="transition-all py-1 border group [&#38;.not-top]:bg-background [&#38;.not-top]:border-border border-transparent box-content dark:[&#38;.not-top]:bg-primary-foreground duration-300 mb-16 rounded-xl sm:rounded-2xl sticky top-4 w-full z-30" data-astro-cid-qlfjksao><header class="flex flex-wrap sm:flex-nowrap sm:justify-start text-sm" data-astro-cid-qlfjksao><nav aria-label=global class="flex items-center justify-between mx-auto relative sm:flex sm:items-center w-full" data-astro-cid-qlfjksao><div class="hidden -left-4 -z-10 absolute box-content dark:max-sm:group-[.expanded]:bg-primary-foreground max-sm:group-[.expanded.not-top]:hidden max-sm:group-[.expanded]:block w-[calc(100%+2rem)] !duration-0 -top-8 h-20 max-sm:group-[.expanded]:bg-white" data-astro-cid-qlfjksao></div><a href=/ class="transition-all duration-300 flex-none font-semibold group-[.not-top]:ms-3 sm:group-[.not-top]:ms-5 text-xl" aria-label=Brand data-astro-cid-qlfjksao>Akiのink</a><div class="flex gap-x-4 sm:gap-x-6" data-astro-cid-qlfjksao><div class="transition-all duration-300 dark:group-[.expanded.not-top]:bg-primary-foreground end-0 grid group-[.expanded]:opacity-100 group-[.not-top]:rounded-xl max-md:border-b max-sm:absolute max-sm:group-[.expanded]:bg-background max-sm:group-[.not-top]:border max-sm:group-[.not-top]:pb-2 max-sm:group-[.not-top]:pt-2 max-sm:group-[.not-top]:px-4 max-sm:opacity-0 max-sm:pb-4 max-sm:pt-0 sm:border-0 sm:grid-rows-1 start-0 top-12 z-20" data-astro-cid-qlfjksao id=headerExpandConetent><div class="hidden -left-4 -z-10 absolute box-content dark:max-sm:group-[.expanded]:bg-primary-foreground max-sm:group-[.expanded.not-top]:hidden max-sm:group-[.expanded]:block w-[calc(100%+2rem)] bg-white h-full max-md:border-b top-0" data-astro-cid-qlfjksao></div><div class="flex items-center flex-col sm:flex-row gap-x-5 gap-y-2 justify-center overflow-hidden sm:gap-x-7 transition-colors" data-astro-cid-qlfjksao><a href=/blog class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>Blog </a><a href=/projects class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>Projects </a><a href=/links class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>Links </a><a href=/about class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>About</a><div class="flex flex-row gap-x-3 grow justify-end sm:gap-x-5 sm:w-fit w-full" data-astro-cid-qlfjksao><a href=https://www.travellings.cn/go.html class="px-1 py-2" data-astro-cid-qlfjksao title=Travelling><span class=sr-only data-astro-cid-qlfjksao>Travelling</span> <svg class=size-5 data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-train-2-line data-astro-cid-qlfjksao></use></svg> </a><a href=/search class="px-1 py-2" data-astro-cid-qlfjksao title=Search><span class=sr-only data-astro-cid-qlfjksao>Search</span> <svg class=size-5 data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-search-2-line data-astro-cid-qlfjksao></use></svg></a></div></div></div><div class="transition-all gap-x-4 flex group-[.not-top]:gap-x-2 group-[.not-top]:me-1.5" data-astro-cid-qlfjksao><button class="transition-all border hover:bg-border p-1.5 rounded-md sm:group-[.not-top]:rounded-xl group/dark" id=toggleDarkMode data-astro-cid-qlfjksao><span class=sr-only data-astro-cid-qlfjksao>Dark Theme</span> <svg class="transition-all group-hover/dark:text-primary size-5 dark:hidden" data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-sun-line data-astro-cid-qlfjksao></use></svg> <svg class="transition-all group-hover/dark:text-primary size-5 dark:block hidden" data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-moon-stars-line data-astro-cid-qlfjksao></use></svg></button> <button class="transition-all border hover:bg-border p-1.5 rounded-md sm:group-[.not-top]:rounded-xl sm:hidden" id=toggleMenu data-astro-cid-qlfjksao><span class=sr-only data-astro-cid-qlfjksao>Menu</span> <svg class=size-5 data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-menu-line data-astro-cid-qlfjksao></use></svg></button></div></div></nav></header></header-component><div class=w-full data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><a href=/blog class="transition-all py-1 border group bg-primary-foreground border-border gap-x-1 hover:bg-input inline-flex items-center no-underline px-2 rounded-lg text-muted-foreground text-sm" data-astro-cid-bvzihdzo data-astro-prefetch><svg class="group-hover:stroke-primary stroke-muted-foreground" fill=none height=16 stroke-linecap=round stroke-linejoin=round stroke-width=2.5 viewBox="0 0 24 24" width=16 xmlns=http://www.w3.org/2000/svg><line class="transition-all duration-300 ease-in-out group-hover:scale-x-100 scale-x-0 group-hover:translate-x-0 translate-x-3" x1=19 x2=5 y1=12 y2=12></line><polyline class="transition-all duration-300 ease-in-out group-hover:translate-x-0 translate-x-1" points="12 19 5 12 12 5"></polyline></svg><p class=my-0>Back</p></a><div class="gap-x-10 lg:flex lg:items-start mt-8" data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><aside class="animate -me-24 basis-60 max-lg:hidden order-2 sticky top-[15%]"><toc-heading><h2 class=font-semibold>TABLE OF CONTENTS</h2><ul class="max-h-[70vh] mt-4 overflow-y-scroll text-card-foreground"><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#十二并发编程 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75" aria-label="Scroll to section: 十二、并发编程">十二、并发编程</a></div><ul><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#121-基于进程的并发编程 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 12.1 基于进程的并发编程">12.1 基于进程的并发编程</a></div><ul><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#122-基于io多路复用的并发编程 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 12.2 基于I/O多路复用的并发编程">12.2 基于I/O多路复用的并发编程</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#123-基于线程的并发编程 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 12.3 基于线程的并发编程">12.3 基于线程的并发编程</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#124-多线程程序中的共享变量 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 12.4 多线程程序中的共享变量">12.4 多线程程序中的共享变量</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#125-用信号量同步线程 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 12.5 用信号量同步线程">12.5 用信号量同步线程</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#126-使用线程提高并行性 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 12.6 使用线程提高并行性">12.6 使用线程提高并行性</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#127-其他并发问题 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 12.7 其他并发问题">12.7 其他并发问题</a></div><ul><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#线程安全 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 线程安全">线程安全</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#可重入性 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 可重入性">可重入性</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#竞争 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 竞争">竞争</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#死锁 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 死锁">死锁</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#活锁冲突碰撞 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 活锁：冲突碰撞">活锁：冲突碰撞</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#饥饿如高优先度进程阻塞低优先度进程 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 饥饿：如高优先度进程阻塞低优先度进程">饥饿：如高优先度进程阻塞低优先度进程</a></div></li></ul></li></ul></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#lab class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: LAB:">LAB:</a></div></li></ul></li></ul></toc-heading></aside><article class="break-words flex-grow" data-astro-cid-bvzihdzo data-pagefind-body style="flex-grow:3;flex-shrink:1;flex-basis:60%;--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><div data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))" id=blog-hero><div class="relative animate hero-image max-lg:mx-auto mb-6 prose"><img alt=12-并发编程 decoding=async height=1092 loading=eager src=/_astro/12.BBeEy0zY_kmxfB.webp width=1946 class="relative w-full cover-image h-auto object-contain rounded-2xl z-10" fetchpriority=high inferSize=true><img alt=12-并发编程 decoding=async height=1092 loading=eager src=/_astro/12.BBeEy0zY_kmxfB.webp width=1946 class="duration-300 absolute blur-xl h-full mt-0 opacity-40 start-0 top-4 transition-opacity w-full z-0" fetchpriority=high inferSize=true id=blurImage></div><div class="animate max-lg:mx-auto article-info max-w-[65ch]"><div class="flex flex-wrap gap-x-4 gap-y-2 leading-6 text-muted-foreground text-xs"><div class="flex items-center gap-1"><svg class=size-5><use href=/icons/ui.svg#mingcute-calendar-2-line></use></svg> <samp class=text-muted-foreground><time datetime=2023-02-18T12:47:57.000Z>Feb 18, 2023</time></samp></div><div class="flex items-center gap-1"><svg class=size-5><use href=/icons/ui.svg#mingcute-time-line></use></svg> 18 min read</div><span class="flex items-center gap-1"><svg class=size-5><use href=/icons/project.svg#mingcute-earth-2-line></use></svg> 中文</span></div><h1 class="font-medium mt-4 sm:mb-2 sm:mt-6 sm:text-3xl text-2xl">12-并发编程</h1><div class="flex items-center flex-row flex-wrap gap-x-1 mt-3 sm:mt-5"><svg class=size-5><use href=/icons/ui.svg#mingcute-tag-line></use></svg><div><a href=/tags/csapp class="before:content-['#'] hover:underline hover:underline-offset-4 inline-block" aria-label="View more blogs with the tag csapp" data-pagefind-filter=tag>csapp</a></div></div><div class="mt-3 italic"><blockquote class="text-muted-foreground text-sm"><q>对应 CSAPP 第十二章节</q></blockquote><div class="text-muted-foreground text-sm mt-1"><span class=waline-pageview-count data-path=/blog/12-并发编程></span> views | <span class=waline-comment-count data-path=/blog/12-并发编程></span> comments</div></div></div><div class="sm:mt-6 mt-4 border-t max-lg:mx-auto sm:w-1/3 w-1/2"></div></div><div class="text-muted-foreground dark:prose-invert mt-8 prose prose-base prose-headings:before:-ms-4 prose-headings:before:absolute prose-headings:font-medium prose-headings:text-foreground prose-th:before:content-none prose-zinc animate max-lg:mx-auto" data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))" id=content><h1 id=ics><a href=https://aki-yzh.github.io/2023/02/18/1-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8&#x26;%E7%9B%AE%E5%BD%95 target=_blank rel="nofollow, noopener, noreferrer">ICS</a></h1><hr><h2 id=十二并发编程>十二、并发编程</h2><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 使用应用级并发的应用程序称为并发程序，现代操作系统提供三种基本的构造并发程序的方法：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> 1. 进程</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> 2.I/O多路复用</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> 3.线程</p><h4 id=121-基于进程的并发编程>12.1 基于进程的并发编程</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 在父进程中接受客户端连接请求，然后创建一个新的子进程来为每个新客户端提供服务。 服务器接收客户端的连接请求后，服务器<code>fork</code>出一个子进程->子进程关闭<code>listenfd</code>，父进程关闭<code>connfd</code>，避免内存泄漏->子进程执行完后自动关闭连接，父进程继续监听</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 优点：简单，地址空间独立，共享状态信息</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 缺点：难共享信息，进程间通信开销高</p><p><strong>基于进程的并发echo服务器</strong>：</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#include</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"csapp.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> echo</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> connfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sigchld_handler</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> sig</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>waitpid</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,WNOHANG)</span><span style=color:#d73a49;--shiki-dark:#F97583>></span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        ;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    return</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> main</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> argc</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>char</span><span style=color:#d73a49;--shiki-dark:#F97583> **</span><span style=color:#e36209;--shiki-dark:#FFAB70>argv</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> listenfd,connfd;</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    socklen_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientlen;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    struct</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sockaddr_storage</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientaddr;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argc </span><span style=color:#d73a49;--shiki-dark:#F97583>!=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        fprintf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(stderr,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"usage: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%s</span><span style=color:#032f62;--shiki-dark:#9ECBFF> &#x3C;port></span><span style=color:#005cc5;--shiki-dark:#79B8FF>\n</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Signal</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(SIGCHLD,sigchld_handler);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    listenfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Open_listenfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        clientfdlen </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#d73a49;--shiki-dark:#F97583> sizeof</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(struct sockaddr_storage);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        connfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Accept</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,(SA </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientaddr,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientlen);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Fork</span><span style=color:#24292e;--shiki-dark:#E1E4E8>() </span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            Closr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            echo</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            Close</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        }</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        Close</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span></code></pre><h4 id=122-基于io多路复用的并发编程>12.2 基于I/O多路复用的并发编程</h4><p>I/O 多路复用的思想：同时监测若干个文件描述符是否可以执行IO操作的能力</p><p>当描述符准备好可读时再去读，读的时候再判断是从哪个描述符读的</p><p><code>select</code>确定要等待的描述符：<em>读集合</em></p><p>状态机：等待描述符准备好、描述符准备好可以读、从描述符读一个文本行</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 优点：一个逻辑控制流，一个地址空间，没有进程/线程管理</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 缺点：编码复杂，只能在一个核上跑</p><p><strong>基于I/O多路复用的迭代echo服务器</strong></p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#include</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"csapp.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> echo</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> connfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> command</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> main</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> argc</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>char</span><span style=color:#d73a49;--shiki-dark:#F97583> **</span><span style=color:#e36209;--shiki-dark:#FFAB70>argv</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> listenfd,connfd;</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    socklen_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientlen;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    struct</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sockaddr_storage</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientaddr;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    fd_set read_set,ready_set;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argc</span><span style=color:#d73a49;--shiki-dark:#F97583>!=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        fprintf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(stderr,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"usage: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%s</span><span style=color:#032f62;--shiki-dark:#9ECBFF> &#x3C;port></span><span style=color:#005cc5;--shiki-dark:#79B8FF>\n</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    listenfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Open_listenfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argc[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    FD_ZERO</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(read_set);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* clear read set */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    FD_SET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(STDIN_FILENO,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>read_set);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* add stdin to read set */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    FD_SET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>read_set);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* add listenfd to read set */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        ready_set</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>read set;</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        Select</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd</span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>ready_set,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>FD_ISSET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(STDIN_FILENO,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>ready_set))</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            command</span><span style=color:#24292e;--shiki-dark:#E1E4E8>();</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Read command line from stdin */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>FD_ISSET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>ready_set))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            clientlen </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#d73a49;--shiki-dark:#F97583> sizeof</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(struct sockaddr_storage);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            connfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Accept</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,(SA</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientaddr,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientlen);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            echo</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* echo client input until EOF */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            Close</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> command</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    char</span><span style=color:#24292e;--shiki-dark:#E1E4E8> buf[MAXLINE];</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>!</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Fgets</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(buf,MAXLINE,stdin))</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    printf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#005cc5;--shiki-dark:#79B8FF>%s</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,buf);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* process to the input command */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span></code></pre><p><strong>基于I/O多路复用的并发echo服务器</strong></p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>#inlcude</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"csapp.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>typedef</span><span style=color:#d73a49;--shiki-dark:#F97583> struct</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* represents a pool of connected descriptors */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> maxfd;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* largest descriptor in read_set */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    fd_set read_set;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* set of all active descriptors */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    fd_set ready_set;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Subset of descriptors ready for reading */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> nready;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Number of ready descriptors from select */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> maxi;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* High water index into client array */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientfd[FD_SETSIZE];</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Set of active descriptors */</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    rio_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientrio[FD_SETSIZE];</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Set of active read buffers */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>} </span><span style=color:#6f42c1;--shiki-dark:#B392F0>pool</span><span style=color:#24292e;--shiki-dark:#E1E4E8> ;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> byte_cnt </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Counts total bytes received by server */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> main</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> argc</span><span style=color:#24292e;--shiki-dark:#E1E4E8> ,</span><span style=color:#d73a49;--shiki-dark:#F97583>char</span><span style=color:#d73a49;--shiki-dark:#F97583> **</span><span style=color:#e36209;--shiki-dark:#FFAB70> argv</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> listenfd,connfd;</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    socklen_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientlen;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    struct</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sockaddr_storage</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientaddr;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    static</span><span style=color:#24292e;--shiki-dark:#E1E4E8> pool pool;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argc</span><span style=color:#d73a49;--shiki-dark:#F97583>!=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        fprinf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(stderr,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"usage: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%s</span><span style=color:#032f62;--shiki-dark:#9ECBFF> &#x3C;port></span><span style=color:#005cc5;--shiki-dark:#79B8FF>\n</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    listenfd</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Open_listenfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    init_pool</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>pool);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        /* wait for listening/connected descriptors to be ready */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        pool.ready_set</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>pool.read_set;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        pool.nready</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Select</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(pool.maxfd</span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>pool.readyset,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        /* if listening descriptor ready , add new client to pool */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>FD_ISSET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>pool.ready_set))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            clientlen</span><span style=color:#d73a49;--shiki-dark:#F97583>=sizeof</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(struct sockaddr_storage);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            connfd</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Accept</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,(SA</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientaddr,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientlen);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            add_client</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>pool);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        }</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        /* echo a text line from each ready connected descriptor */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        check_clients</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>pool);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> init_pool</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> listenfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#6f42c1;--shiki-dark:#B392F0>pool</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>p</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>//初始化客户端池</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    /* initially ,there are no connected descriptors */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> i;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    p->maxi </span><span style=color:#d73a49;--shiki-dark:#F97583>=-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    for</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(i</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8> ;i</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x3C;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>FD_SETSIZE;i</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        p->clientfd[i]</span><span style=color:#d73a49;--shiki-dark:#F97583>=-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    /* initially ,listenfd is only member of select read set */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    p->maxfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> listenfd;</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    FD_ZERO</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->read_set);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    FD_SET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->read_set);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> add_client</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> connfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#6f42c1;--shiki-dark:#B392F0>pool</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>p</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>//向池中添加一个新的客户端连接</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> i;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    p->nready</span><span style=color:#d73a49;--shiki-dark:#F97583>--</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    for</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(i</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;i</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x3C;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>FD_SETSIZE,i</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* find an available slot */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(p->clientfd[i]</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x3C;</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        {</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>            /* Add connected descriptor to the pool */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            p->clientfd[i]</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>connfd;</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            Rio_readinitb</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->clientrio[i],connfd);</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>            /* add the descriptor to descriptor set */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            FD_SET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->read_set);</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>            /* update max descriptor and pool high water mark */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>            if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd</span><span style=color:#d73a49;--shiki-dark:#F97583>></span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->maxfd)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                p->maxfd</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>connfd;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>            if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(i</span><span style=color:#d73a49;--shiki-dark:#F97583>></span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->maxi)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                p->maxi</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>i;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>            break</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        }</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(i</span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#24292e;--shiki-dark:#E1E4E8>FD_SETSIZE)</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* couldn't find an empty slot */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        app_error</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"add_client error: too mant clients"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> check_clients</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>pool</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>p</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>//服务准备好的客户端链接</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> i,connfd,n;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    char</span><span style=color:#24292e;--shiki-dark:#E1E4E8> buf[MAXLINE];</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    rio_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> rio;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    for</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(i</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;(i</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x3C;=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->maxi)</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(p->nready</span><span style=color:#d73a49;--shiki-dark:#F97583>></span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);i</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        connfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> p->clientfd[i];</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        rio</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->clientrio[i];</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        /* if the descriptor is ready ,echo a text line from it */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>((connfd</span><span style=color:#d73a49;--shiki-dark:#F97583>></span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>FD_ISSET</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->ready_set)))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            p->nready</span><span style=color:#d73a49;--shiki-dark:#F97583>--</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>            if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>((n</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Rio_readlineb</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>rio,buf,MAXLINE))</span><span style=color:#d73a49;--shiki-dark:#F97583>!=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                byte_cnt</span><span style=color:#d73a49;--shiki-dark:#F97583>+=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>n;</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>                printf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"Server received </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%d</span><span style=color:#032f62;--shiki-dark:#9ECBFF> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>%d</span><span style=color:#032f62;--shiki-dark:#9ECBFF> total) bytes on fd </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%d\n</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,n,byte_cnt,connfd);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>                Rio_writen</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd,buf,n);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            }</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>            /* EOF decteced ,remove descriptor from pool */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>            else</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>                Close</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>                FD_CLR</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>p->read_set);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                p->clientfd[i]</span><span style=color:#d73a49;--shiki-dark:#F97583>=-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span></code></pre><h4 id=123-基于线程的并发编程>12.3 基于线程的并发编程</h4><p>线程：进程上下文中的逻辑流</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 共享代码、数据、堆、共享库和打开的文件</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 私有的线程ID、栈、栈指针、寄存器</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 和一个进程相关的线程组成一个对等线程池</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 上下文切换、创建和终止比进程快</p><p>每个进程开始生命周期时都是单一线程，这个线程称为主线程，在某一时刻，主线程创建一个对等线程，从这个时间点开始，两个线程并发运行。</p><p><strong>Posix</strong>线程：</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>typedef</span><span style=color:#d73a49;--shiki-dark:#F97583> void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>func</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 创建其他线程 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> pthread_create</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>pthread_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>tid</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>pthread_attr_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>attr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#6f42c1;--shiki-dark:#B392F0>func</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>f</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>arg</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>//成功返回0，出错非0</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 返回调用者的线程id */</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>pthread_t</span><span style=color:#6f42c1;--shiki-dark:#B392F0> pthread_self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 终止线程 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> pthread_exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>thread_return</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>//从不返回</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> pthread_cancel</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>pthread_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> tid</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>//成功返回0，出错非0</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 等待其他线程终止 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> pthread_join</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>pthread_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> tid</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> **</span><span style=color:#e36209;--shiki-dark:#FFAB70>thread_return</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>//成功返回0，出错非0</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 分离线程 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> pthread_detach</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>pthread_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> tid</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>//成功返回0，出错非0</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 初始化线程 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> pthread_once</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>pthread_once_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>once_control</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (*</span><span style=color:#e36209;--shiki-dark:#FFAB70>init_routine</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>));</span><span style=color:#6a737d;--shiki-dark:#6A737D>//总是返回0</span></span>
<span class=line></span></code></pre><p><strong>基于线程的并发echo服务器</strong>:</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#include</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"csapp.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> echo</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> connfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>thread</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#e36209;--shiki-dark:#FFAB70> vargp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> main</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> argc</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>char</span><span style=color:#d73a49;--shiki-dark:#F97583> **</span><span style=color:#e36209;--shiki-dark:#FFAB70>argv</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> listenfd,</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>connfdp;</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    socklen_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientlen;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    struct</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sockaddr_storage</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientaddr;</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    pthread_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tid;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argc </span><span style=color:#d73a49;--shiki-dark:#F97583>!=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        fprintf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(stderr,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"usage: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%s</span><span style=color:#032f62;--shiki-dark:#9ECBFF> &#x3C;port></span><span style=color:#005cc5;--shiki-dark:#79B8FF>\n</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    listenfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Open_listenfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argc[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        clientlen </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#d73a49;--shiki-dark:#F97583> sizeof</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(struct sockaddr_storage);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        connfdp </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Malloc</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>sizeof</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#24292e;--shiki-dark:#E1E4E8>));</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        *</span><span style=color:#24292e;--shiki-dark:#E1E4E8>connfdp </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Accept</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd ,(SA </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientaddr,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientlen);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        Pthread_creat</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>tid,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,thread,connfdp);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* Thread routine */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>thread</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>vargp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> connfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8>((</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)vargp);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Pthread_detach</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>pthread_self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>());</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Free</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(vargp);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    echo</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Close</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span>
<span class=line></span></code></pre><h4 id=124-多线程程序中的共享变量>12.4 多线程程序中的共享变量</h4><p>多线程的C程序中变量根据他们的存储类型倍映射到虚拟内存：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <strong>全局变量</strong>：虚拟内存的读 / 写区域只包含每个全局变量的一个实例</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <strong>本地自动变量</strong>：定义在函数内部但不<code>static</code>，每个线程的栈都包含它自己的所有本地自动变量的实例</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <strong>本地静态变量</strong>：只有一个实例，每个对等线程都读 / 写这个实例</p><p><strong>共享变量</strong></p><p>变量是共享的 ⇔ 它的一个实例被一个以上的线程引用</p><p>本地自动变量也能被共享</p><h4 id=125-用信号量同步线程>12.5 用信号量同步线程</h4><p><strong>进程图</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 将n个并发线程的执行模型化为一条n维笛卡尔空间中的轨迹线，每条轴k对应于线程k的进度。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> 对<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>H</mi><mn>1</mn></msub><mo separator=true>,</mo><msub><mi>L</mi><mn>1</mn></msub><mo separator=true>,</mo><msub><mi>U</mi><mn>1</mn></msub><mo separator=true>,</mo><msub><mi>H</mi><mn>2</mn></msub><mo separator=true>,</mo><msub><mi>L</mi><mn>2</mn></msub><mo separator=true>,</mo><msub><mi>S</mi><mn>1</mn></msub><mo separator=true>,</mo><msub><mi>T</mi><mn>1</mn></msub><mo separator=true>,</mo><msub><mi>U</mi><mn>2</mn></msub><mo separator=true>,</mo><msub><mi>S</mi><mn>2</mn></msub><mo separator=true>,</mo><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding=application/x-tex>H_1,L_1,U_1,H_2,L_2,S_1,T_1,U_2,S_2,T_2</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8778em;vertical-align:-.1944em class=strut></span><span class=mord><span style=margin-right:.08125em class="mord mathnormal">H</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.0813em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:0;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span style=margin-right:.10903em class="mord mathnormal">U</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span style=margin-right:.08125em class="mord mathnormal">H</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.0813em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:0;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span style=margin-right:.13889em class="mord mathnormal">T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span style=margin-right:.10903em class="mord mathnormal">U</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span style=margin-right:.13889em class="mord mathnormal">T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3011em class=vlist><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span> 的轨迹线：</p><img alt="" decoding=async height=418 loading=lazy src=/_astro/20230216212506.BMlpRyT4_Z1Sc3Nq.webp width=464><p><strong>信号量</strong></p><img alt="" decoding=async height=840 loading=lazy src=/_astro/20230216215854.JatSnmi4_1TKHVW.webp width=898><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 具有非负整数值的全局变量<code>s</code>，两种操作：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <code>P(s)</code>：如果<code>s</code>非零，则将<code>s</code>减1，返回；<code>s</code>为0，就挂起线程，直到<code>s</code>变为非0，<code>V</code>会重启这个线程，重启后<code>P</code>将<code>s</code>减1，返回</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <code>V(s)</code>：将<code>s</code>加1，如果有线程阻塞在<code>P</code>且等着<code>s</code>变为非零，则<code>V</code>会重启这些线程中的一个</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 同一时间，只有一个<code>P</code>或一个<code>V</code>能改变<code>s</code>变量；</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 多个线程在等待同一个信号量时，无法预测<code>V</code>要重启哪个线程</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 信号量不变性_：信号量不会为负</p><p>P和V的包装函数：</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>sem_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>s</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Wrapper function for sem_wait */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>sem_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>s</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Wrapper function for sem_post */</span></span>
<span class=line></span></code></pre><p><strong>调度共享资源</strong></p><ol><li><strong>生产者 - 消费者问题</strong></li></ol><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 生产者和消费者线程共享一个有<code>n</code>个槽的有限缓冲区，生产者反复生成新的项目并加入缓冲区中，消费者不断从缓冲区中取出这些项目，然后处理</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 插入和去除项目都涉及更新共享变量，所以必须保证对缓冲区的访问是互斥的，同时要调度对缓冲区的访问：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 如果缓冲区是满的，生产者必须等待，直到有槽位可用</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 如果缓冲区是空的。消费者必须等待，直到有槽位不为空</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#include</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"csapp.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#include</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"sbuf.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>typedef</span><span style=color:#d73a49;--shiki-dark:#F97583> struct</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8>buf;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Buffer array */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> n;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Maxium number of slots */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> front;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* buf[(front+1)%n] is first item */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> rear;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* buf[rear%n] is last item */</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    sem_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> mutex;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Protect accesses to buf */</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    sem_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> slots;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Counts available slots */</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    sem_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> items;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Counts available items */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>} </span><span style=color:#6f42c1;--shiki-dark:#B392F0>sbuf_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* Creat an empty bounded shared FIFO buffer with n slots */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sbuf_init</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>sbuf_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>sp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> n</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    sp->buf </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Calloc</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(n, </span><span style=color:#d73a49;--shiki-dark:#F97583>sizeof</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#24292e;--shiki-dark:#E1E4E8>));</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    sp->n </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> n;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* buffer holds max of n items */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    sp->front</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->rear</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Empty buffer iff front=rear */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Sem_init</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->mutex, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D> /*Binary semaphore for locking */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Sem_init</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->slots, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, n);</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* initially buf has n empty slots */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Sem_init</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->items, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* initially, buf has zeor dara items */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* clean up buffer sp */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sbuf_deinit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>sbuf_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>sp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Free</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(sp->buf);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* insert item onto the rear of shared buffer sp */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sbuf_insert</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>sbuf_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>sp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> item</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->slots);</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* wait for available slots */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->mutex);</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* lock the buffer */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    sp->buf[(</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->rear)</span><span style=color:#d73a49;--shiki-dark:#F97583>%</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(sp->n)]</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>item ;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* insert the item */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->mutex);</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* Unlock the buffer */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->items);</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* Announce available item */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* Remove and return the first item from buffer sp */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sbuf_remove</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>sbuf_t</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>sp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> item;</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->items);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* wait for available item */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->mutex);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* lock the buffer */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    item </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> sp->buf[(</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->front)</span><span style=color:#d73a49;--shiki-dark:#F97583>%</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(sp->n)];</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* remove the item */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->mutex);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Unlock the buffer */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sp->slots);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Announce available item */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> item;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span></code></pre><ol start=2><li><strong>读者-写者模型</strong></li></ol><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> 一组并发的线程要访问一个共享对象，有些线程只读对象，其他的修改对象。只读对象的线程为读者，修改对象的为写者。写者必须独占对象，读者可以和其他读者共享对象，考虑有无限多个并发的读者和写者.</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> <strong>第一类</strong>：不让读者等待，除非此时有写者。读者不会因为有写者在等待而等待：</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> readcnt;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* initially = 0 */</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>sem_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> mutex, w;</span><span style=color:#6a737d;--shiki-dark:#6A737D> /* initially 1 */  // mutex为readcnt的互斥锁</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> reader</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        readcnt</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (readcnt </span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* first in */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    /*  reading happens */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        readcnt</span><span style=color:#d73a49;--shiki-dark:#F97583>--</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (readcnt </span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* last out */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> writer</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>       /* writing happens*/</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span></code></pre><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> <strong>第二类</strong>：写者优先，写者后到达的读者也必须等待这个写者完成</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> readcnt, writecnt;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* initially 0 */</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>sem_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> rmutex, wmutex, r, w;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* initially 1 */</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> reader</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>r);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>rmutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        readcnt</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (readcnt </span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>rmutex);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>r);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        /* reading */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>rmutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        readcnt</span><span style=color:#d73a49;--shiki-dark:#F97583>--</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (readcnt </span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>rmutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> writer</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>wmutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        writecnt</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (writecnt </span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            p</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>r);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(wmutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        /*  writing */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>w);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>wmutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        writecnt</span><span style=color:#d73a49;--shiki-dark:#F97583>--</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (writecnt </span><span style=color:#d73a49;--shiki-dark:#F97583>==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>            V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>r);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>wmutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span></code></pre><p><strong>基于预线程化的并发服务器</strong></p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#include</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"csapp.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#include</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"sbuf.h"</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#define</span><span style=color:#6f42c1;--shiki-dark:#B392F0> NTHREADS</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 4</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>#define</span><span style=color:#6f42c1;--shiki-dark:#B392F0> SBUFSIZE</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 16</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> echo_cnt</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> connfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>thread</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>vargp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>sbuf_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> sbuf;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* shared buffer of connected descriptors */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> main</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> argc</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>char</span><span style=color:#d73a49;--shiki-dark:#F97583> **</span><span style=color:#e36209;--shiki-dark:#FFAB70>argv</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> i,listenfd,counnfd;</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    socklen_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientlen;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    struct</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sockaddr_storage</span><span style=color:#24292e;--shiki-dark:#E1E4E8> clientaddr;</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    pthread_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tid;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argc</span><span style=color:#d73a49;--shiki-dark:#F97583>!=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        fprintf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(stderr,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"usage: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%s</span><span style=color:#032f62;--shiki-dark:#9ECBFF> &#x3C;port></span><span style=color:#005cc5;--shiki-dark:#79B8FF>\n</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        exit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    listenfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> Open_listenfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(argv[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    sbuf_init</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sbuf,SBUFSIZE);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    for</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(i </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span><span style=color:#24292e;--shiki-dark:#E1E4E8> ;i</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x3C;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>NTHREADS;i</span><span style=color:#d73a49;--shiki-dark:#F97583>++</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* Creat worker threads */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        Pthread_creat</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>tid,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,thread,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>NULL</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        clientlen</span><span style=color:#d73a49;--shiki-dark:#F97583>=sizeof</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(struct sockaddr_storage);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        connfd</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Accept</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(listenfd,(SA</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientaddr,</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>clientlen);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        sbuf_insert</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sbuf,connfd);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* insert connfd in buffer */</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>thread</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>vargp</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Pthread_detach</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>pthread_self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>());</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> connfd </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0> sbuf_remove</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sbuf);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* remove connfd from buffer */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        echo_cnt</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* service client */</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        Close</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>static</span><span style=color:#d73a49;--shiki-dark:#F97583> int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> byte_cnt;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* byte counter */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>static</span><span style=color:#005cc5;--shiki-dark:#79B8FF> sem_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> mutex;</span><span style=color:#6a737d;--shiki-dark:#6A737D>/* and the mutex thar protects it */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>static</span><span style=color:#d73a49;--shiki-dark:#F97583> void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> init_echo_cnt</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Sem_init</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mutex,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    byte_cnt</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>;</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> echo_cnt</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> connfd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>{</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    int</span><span style=color:#24292e;--shiki-dark:#E1E4E8> n;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    char</span><span style=color:#24292e;--shiki-dark:#E1E4E8> buf[MAXLINE];</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    rio_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> rio;</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    static</span><span style=color:#005cc5;--shiki-dark:#79B8FF> pthread_once_t</span><span style=color:#24292e;--shiki-dark:#E1E4E8> once </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> PTHREAD_ONCE_INIT;</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Pthread_once</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>once ,init_echo_cnt);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>    Rio_readinitb</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>rio,connfd);</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    while</span><span style=color:#24292e;--shiki-dark:#E1E4E8>((n</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Rio_readlineb</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>rio,buf,MAXLINE))</span><span style=color:#d73a49;--shiki-dark:#F97583>!=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    {</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        P</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mutex);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>        byte_cnt</span><span style=color:#d73a49;--shiki-dark:#F97583>+=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>n;</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        printf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"server received </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%d</span><span style=color:#032f62;--shiki-dark:#9ECBFF> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>%d</span><span style=color:#032f62;--shiki-dark:#9ECBFF> total) bytes on fd </span><span style=color:#005cc5;--shiki-dark:#79B8FF>%d</span><span style=color:#005cc5;--shiki-dark:#79B8FF> \n</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,n.byte_cnt,connfd);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        V</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>&#x26;</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mutex);</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>        Rio_writen</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(connfd,buf,n);</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    }</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>}</span></span>
<span class=line></span>
<span class=line></span></code></pre><h4 id=126-使用线程提高并行性>12.6 使用线程提高并行性</h4><p>同步（互斥锁）开销巨大，要尽可能避免。如果无可避免，必须要用尽可能多的有用计算弥补这个开销</p><p>如：不要用互斥锁保护同一个全局变量，在每个对等线程中用私有变量计算部分和（每个对等线程把部分和累计到一个私有数组元素中）</p><p>再优化：累积到一个局部变量中，最后再移动到数组中</p><p><strong>刻画并行程序的性能</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 线程数 &#x3C; 核数：时间降低：线程数增加一倍，时间下降一半</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 线程数 > 核数：时间增加（一点）：上下文切换开销</p><p>公式：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span><strong>加速比</strong>：<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub><mo>=</mo><mfrac><msub><mi>T</mi><mn>1</mn></msub><msub><mi>T</mi><mi>p</mi></msub></mfrac></mrow><annotation encoding=application/x-tex>S_p = \frac{T_1}{T_p}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.9694em;vertical-align:-.2861em class=strut></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.2861em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1.4308em;vertical-align:-.5423em class=strut></span><span class=mord><span class="nulldelimiter mopen"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.8884em class=vlist><span style=top:-2.655em><span style=height:3em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight"><span class="mord mtight"><span style=margin-right:.13889em class="mord mtight mathnormal">T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1645em class=vlist><span style=top:-2.357em;margin-left:-.1389em;margin-right:.0714em><span style=height:2.5em class=pstrut></span><span class="mtight sizing reset-size3 size1"><span class="mord mtight mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.2819em class=vlist><span></span></span></span></span></span></span></span></span></span><span style=top:-3.23em><span style=height:3em class=pstrut></span><span style=border-bottom-width:.04em class=frac-line></span></span><span style=top:-3.4101em><span style=height:3em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight"><span class="mord mtight"><span style=margin-right:.13889em class="mord mtight mathnormal">T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3173em class=vlist><span style=top:-2.357em;margin-left:-.1389em;margin-right:.0714em><span style=height:2.5em class=pstrut></span><span class="mtight sizing reset-size3 size1"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.143em class=vlist><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.5423em class=vlist><span></span></span></span></span></span><span class="nulldelimiter mclose"></span></span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>p</mi></mrow><annotation encoding=application/x-tex>p</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.625em;vertical-align:-.1944em class=strut></span><span class="mord mathnormal">p</span></span></span></span> 为处理器核数，<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>T</mi><mi>K</mi></msub></mrow><annotation encoding=application/x-tex>T_K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8333em;vertical-align:-.15em class=strut></span><span class=mord><span style=margin-right:.13889em class="mord mathnormal">T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3283em class=vlist><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span style=margin-right:.07153em class="mord mtight mathnormal">K</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span> 为在 k 个核上的运行时间</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> T1 为程序顺序执行版本的执行时间：<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding=application/x-tex>S_p</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.9694em;vertical-align:-.2861em class=strut></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.2861em class=vlist><span></span></span></span></span></span></span></span></span></span> 为 <em>绝对加速比</em></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:2em class=mspace></span></span></span></span> T1 为程序并行版本在一个核上的执行时间：<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding=application/x-tex>S_p</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.9694em;vertical-align:-.2861em class=strut></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.2861em class=vlist><span></span></span></span></span></span></span></span></span></span> 为 <em>相对加速比</em></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span><strong>效率</strong>：<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>E</mi><mi>p</mi></msub><mo>=</mo><mfrac><msub><mi>S</mi><mi>p</mi></msub><mi>p</mi></mfrac><mo>=</mo><mfrac><msub><mi>T</mi><mn>1</mn></msub><mrow><mi>p</mi><msub><mi>T</mi><mi>p</mi></msub></mrow></mfrac></mrow><annotation encoding=application/x-tex>E_p = \frac{S_p}{p}=\frac{T_1}{p{T_p}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.9694em;vertical-align:-.2861em class=strut></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.2861em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1.4668em;vertical-align:-.4811em class=strut></span><span class=mord><span class="nulldelimiter mopen"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.9857em class=vlist><span style=top:-2.655em><span style=height:3em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight"><span class="mord mtight mathnormal">p</span></span></span></span><span style=top:-3.23em><span style=height:3em class=pstrut></span><span style=border-bottom-width:.04em class=frac-line></span></span><span style=top:-3.5073em><span style=height:3em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight"><span class="mord mtight"><span style=margin-right:.05764em class="mord mtight mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1645em class=vlist><span style=top:-2.357em;margin-left:-.0576em;margin-right:.0714em><span style=height:2.5em class=pstrut></span><span class="mtight sizing reset-size3 size1"><span class="mord mtight mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.2819em class=vlist><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.4811em class=vlist><span></span></span></span></span></span><span class="nulldelimiter mclose"></span></span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1.4308em;vertical-align:-.5423em class=strut></span><span class=mord><span class="nulldelimiter mopen"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.8884em class=vlist><span style=top:-2.655em><span style=height:3em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight"><span class="mord mtight mathnormal">p</span><span class="mord mtight"><span class="mord mtight"><span style=margin-right:.13889em class="mord mtight mathnormal">T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1645em class=vlist><span style=top:-2.357em;margin-left:-.1389em;margin-right:.0714em><span style=height:2.5em class=pstrut></span><span class="mtight sizing reset-size3 size1"><span class="mord mtight mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.2819em class=vlist><span></span></span></span></span></span></span></span></span></span></span><span style=top:-3.23em><span style=height:3em class=pstrut></span><span style=border-bottom-width:.04em class=frac-line></span></span><span style=top:-3.4101em><span style=height:3em class=pstrut></span><span class="mtight sizing reset-size6 size3"><span class="mord mtight"><span class="mord mtight"><span style=margin-right:.13889em class="mord mtight mathnormal">T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.3173em class=vlist><span style=top:-2.357em;margin-left:-.1389em;margin-right:.0714em><span style=height:2.5em class=pstrut></span><span class="mtight sizing reset-size3 size1"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.143em class=vlist><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.5423em class=vlist><span></span></span></span></span></span><span class="nulldelimiter mclose"></span></span></span></span></span>：百分比，对由于并行化造成的开销的衡量</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span><strong>弱扩展</strong>：增加处理器数量的同时，增加问题的规模，使得每个处理器执行的工作量保持不变：更加真实</p><h4 id=127-其他并发问题>12.7 其他并发问题</h4><h5 id=线程安全>线程安全</h5><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span><strong>线程安全的函数</strong>：当且仅当它被多个并发线程反复调用时，能够一直产生正确的结果</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 线程不安全函数类：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 1. 不保护共享变量的函数</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 2. 保持跨越多个调用的状态的函数（如：<code>rand</code>，<code>srand</code>，当前调用的结果取决于前一次调用的结果，多线程中无法获得相同的序列）</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 3. 返回指向静态变量指针的函数：<code>ctime, gethostbyname</code>：正在被一个线程使用的结果可能被另一个线程覆盖</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 解决方法：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 1. 重写函数</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 2. 将线程不安全函数与互斥锁联系起来：每次调用时用互斥锁加锁，将返回的结果复制到一个私有的内存位置，再解锁（包装函数）</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 4. 调用线程不安全函数的函数（不一定：如果是1，3类函数，加了互斥锁就是安全的，2只有重写函数）</p><h5 id=可重入性>可重入性</h5><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 被多个线程调用时，不会引用_任何_共享数据</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 线程安全包含可重入</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> <strong>显式可重入</strong>：所有的函数参数都是传值传递，所有的数据引用都是本地的自动栈变量</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 隐式可重入：参数有传指针：小心使用就是可重入的</p><h5 id=竞争>竞争</h5><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 一个程序的正确性依赖于一个线程要在另一个线程到达 y 点之前到达它的控制流中的 x 点：程序员假定线程将通过某种特殊的轨迹线穿过执行状态空间</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 消除竞争：通过<code>Malloc - Free</code>传参等</p><h5 id=死锁>死锁</h5><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 一组线程被阻塞，等待一个永远不会为真的条件</p><img alt="" decoding=async height=906 loading=lazy src=/_astro/20230216205835.BNd-XpY9_ZNpVzE.webp width=580><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 出现：程序员使用P和V信号不当，导致两个信号量的禁止区域重叠</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:0 class=strut></span><span style=margin-right:1em class=mspace></span></span></span></span> 避免死锁：<code>互斥锁加锁顺序规则</code>：给定所有互斥操作的一个全序，如果每个线程都是以一种顺序获得互斥锁并以相反的顺序释放，那么这个程序就是无死锁的</p><h5 id=活锁冲突碰撞>活锁：冲突碰撞</h5><h5 id=饥饿如高优先度进程阻塞低优先度进程>饥饿：如高优先度进程阻塞低优先度进程</h5><hr><h3 id=lab>LAB:</h3><p><strong>此章节后完成<a href=https://github.com/Aki-yzh/PKU-ICS-2022/tree/main/LABS/8-proxylab target=_blank rel="nofollow, noopener, noreferrer">proxylab(75.0/100.0)</a></strong></p></div></article></div><div class="text-muted-foreground dark:prose-invert mt-8 prose prose-base prose-headings:before:-ms-4 prose-headings:before:absolute prose-headings:font-medium prose-headings:text-foreground prose-th:before:content-none prose-zinc" data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><div class="flex flex-col gap-y-2 border px-3 py-2 relative rounded-xl sm:px-4 sm:py-3"><svg class="opacity-10 absolute end-4 size-20 top-4"><use href=/icons/copyright-sponsor.svg#mingcute-copyright-line></use></svg><div class="flex flex-col"><div class=text-foreground>12-并发编程</div><div class=text-sm>https://astro-theme-pure.vercel.app/blog/12-并发编程</div></div><div class="flex flex-row flex-wrap gap-x-5 gap-y-1 justify-start sm:gap-x-8"><div class="flex gap-x-2 sm:flex-col"><span class=text-foreground>Author</span> <span class="text-sm max-sm:place-self-center">Aki</span></div><div class="flex gap-x-2 sm:flex-col sm:min-w-16"><span class=text-foreground>Update date</span> <span class="text-sm max-sm:place-self-center">February 18, 2023</span></div><div class="flex gap-x-2 sm:flex-col"><span class=text-foreground>Copyright</span> <a href=https://creativecommons.org/licenses/by/4.0/ class="text-muted-foreground text-sm max-sm:place-self-center" target=_blank>CC BY-NC-SA 4.0</a></div></div><div class=relative><div class="flex flex-row gap-3"><button class="transition-colors group bg-primary-foreground hover:text-primary p-1 rounded-full sm:p-1.5 text-muted-foreground" id=copy-link><svg class=size-5><use href=/icons/copyright-sponsor.svg#mingcute-link-2-line></use></svg></button><button class="transition-colors group bg-primary-foreground hover:text-primary p-1 rounded-full sm:p-1.5 text-muted-foreground" id=get-qrcode><svg class=size-5><use href=/icons/copyright-sponsor.svg#mingcute-qrcode-2-line></use></svg></button><button class="transition-colors group bg-primary-foreground hover:text-primary p-1 rounded-full sm:p-1.5 text-muted-foreground" id=share-weibo><svg class=size-5><use href=/icons/copyright-sponsor.svg#mingcute-weibo-line></use></svg></button></div><div class="transition-all duration-300 ease-in-out *:my-0 -mt-2 absolute aria-expanded:max-h-[256px] aria-expanded:opacity-100 aria-expanded:translate-y-4 bg-primary-foreground border box-content max-h-0 opacity-0 overflow-hidden p-4 rounded-xl z-10" id=qrcode aria-expanded=false></div></div></div><div class="border-t-0 border mx-6 pb-1.5 pt-1 px-3 rounded-b-xl sm:mx-8 sm:px-4"><a href=/projects#sponsorship class="flex justify-between no-underline text-muted-foreground" target=_blank><div>Buy me a cup of coffee ☕.</div><svg class="size-5 m-1"><use href=/icons/copyright-sponsor.svg#mingcute-receive-money-line></use></svg></a></div><script type=module>import QRCode from"/scripts/qrcode.js";const link=window.location.href,copyLink=document.getElementById("copy-link");function loadqrcode(e){if(!e)throw new Error("qrcode container not found");""===e.innerHTML&&new QRCode(e,link)}copyLink?.addEventListener("click",(()=>{navigator.clipboard.writeText(link)}));const getQRCode=document.getElementById("get-qrcode"),qrcodeContainer=document.getElementById("qrcode");if(!qrcodeContainer)throw new Error("qrcode container not found");getQRCode?.addEventListener("click",(()=>{"true"===qrcodeContainer.ariaExpanded?qrcodeContainer.ariaExpanded="false":(loadqrcode(qrcodeContainer),qrcodeContainer.ariaExpanded="true")}));const shareWeibo=document.getElementById("share-weibo");shareWeibo?.addEventListener("click",(()=>{const e=`http://service.weibo.com/share/share.php?url=${link}&title=${document.title}&pic=https://cravatar.cn/avatar/1ffe42aa45a6b1444a786b1f32dfa8aa?s=400`;window.open(e,"_blank")}))</script><div class="mt-3 sm:mt-6 gap-2 grid grid-cols-1 sm:gap-4 sm:grid-cols-2"><a href=/blog/1-课程概述 class="flex items-center border-transparent duration-300 group border gap-3 hover:bg-primary-foreground no-underline px-4 py-2 rounded-lg sm:py-4 transition-colors"><svg class="transition-colors group-hover:stroke-primary stroke-muted-foreground rotate-180" fill=none height=20 stroke-linecap=round stroke-linejoin=round stroke-width=2.5 viewBox="0 0 24 24" width=20 xmlns=http://www.w3.org/2000/svg><line class="transition-all duration-300 ease-in-out group-hover:translate-x-1 group-hover:scale-x-100 scale-x-0 translate-x-4" x1=5 x2=19 y1=12 y2=12></line><polyline class="transition-all duration-300 ease-in-out group-hover:translate-x-1 translate-x-0" points="12 5 19 12 12 19"></polyline></svg><div class="flex flex-col gap-0.5 grow max-w-[80%] sm:gap-1.5"><div class="text-muted-foreground text-sm font-normal uppercase">Prev</div><div class="transition-colors font-medium truncate whitespace-nowrap">1-课程概述</div></div></a><a href=/blog/11-网络编程 class="flex items-center border-transparent duration-300 group border gap-3 hover:bg-primary-foreground no-underline px-4 py-2 rounded-lg sm:py-4 transition-colors justify-end text-right"><div class="flex flex-col gap-0.5 grow max-w-[80%] sm:gap-1.5"><div class="text-muted-foreground text-sm font-normal uppercase">Next</div><div class="transition-colors font-medium truncate whitespace-nowrap">11-网络编程</div></div><svg class="transition-colors group-hover:stroke-primary stroke-muted-foreground" fill=none height=20 stroke-linecap=round stroke-linejoin=round stroke-width=2.5 viewBox="0 0 24 24" width=20 xmlns=http://www.w3.org/2000/svg><line class="transition-all duration-300 ease-in-out group-hover:translate-x-1 group-hover:scale-x-100 scale-x-0 translate-x-4" x1=5 x2=19 y1=12 y2=12></line><polyline class="transition-all duration-300 ease-in-out group-hover:translate-x-1 translate-x-0" points="12 5 19 12 12 19"></polyline></svg></a></div><comment-component data-astro-cid-ksttp56e><div class="mt-3 sm:mt-6 not-prose" id=waline data-astro-cid-ksttp56e>Comment seems to stuck. Try to refresh?✨</div></comment-component></div><button class="transition-all duration-300 bg-primary-foreground opacity-0 border-2 border-transparent bottom-8 data-[show=true]:opacity-100 data-[show=true]:translate-y-0 end-4 fixed flex group h-10 hover:border-border/75 items-center justify-center rounded-full sm:end-8 sm:h-12 sm:w-12 text-muted-foreground translate-y-28 w-10 z-90" id=to-top-btn aria-label="Back to Top" data-show=false><div class="flex items-center justify-center absolute bottom-0 end-0 group-[.ended]:opacity-0 group-hover:opacity-0 start-0 top-0 transition-opacity"><span class=text>10</span> <span class=text-xs>%</span></div><svg class="size-6 group-[.ended]:opacity-100 group-hover:opacity-100 opacity-0 transition-opacity"><use href=/icons/ui.svg#mingcute-up-line></use></svg></button><script>!function(){const e=document.getElementById("to-top-btn"),t=e.children[0].children[0],n=document.getElementById("blog-hero"),o=document.getElementById("content");e.addEventListener("click",(()=>{document.documentElement.scrollTo({behavior:"smooth",top:0})}));new IntersectionObserver((function(t){t.forEach((t=>{e.dataset.show=(!t.isIntersecting).toString()}))})).observe(n);{const n=o.scrollHeight,c=o.offsetTop,d=document.documentElement.clientHeight;document.addEventListener("scroll",(()=>{const o=function(){var e=document.documentElement.scrollTop||document.body.scrollTop;if(!(e<c))return Math.round((e-c)/(n-d)*100)}();void 0!==o&&(t.innerText=o.toString(),e.classList.toggle("ended",o>100))}))}}()</script></div><footer class="w-full mx-auto mt-24"><div class="border-t border-border pt-5"><div class="flex items-center flex-col sm:flex-row gap-y-3 sm:flex sm:gap-y-0 sm:items-center sm:justify-between"><div class="flex items-center flex-col sm:flex-row gap-2 sm:gap-x-4 text-sm"><p class="">© <samp>2024</samp> Aki. All rights reserved.</p></div><div class="flex items-center justify-between"><div class="flex items-center gap-x-4"><a href=https://github.com/Aki-yzh class="transition-all text-muted-foreground hover:text-muted-foreground/75 inline-block" aria-label=github><svg class=size-6><use href=/icons/social.svg#mingcute-github-line></use></svg> </a><a href=/rss.xml class="transition-all text-muted-foreground hover:text-muted-foreground/75 inline-block" aria-label=rss><svg class=size-6><use href=/icons/social.svg#mingcute-rss-2-line></use></svg></a></div></div></div></div></footer></main></body></html>