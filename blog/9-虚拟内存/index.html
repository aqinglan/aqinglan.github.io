<!DOCTYPE html><html lang="zh-CN, en-US"><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="IE=edge" http-equiv=X-UA-Compatible><title>9-虚拟内存 • Akiのink</title><link href=/favicon/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/favicon/favicon-32x32.png rel=icon type=image/png sizes=32x32><link href=/favicon/favicon-16x16.png rel=icon type=image/png sizes=16x16><link href=/favicon/site.webmanifest rel=manifest><link href=/fonts/Satoshi-Variable.ttf rel=preload type=font/ttf as=font crossorigin><link href=/fonts/Satoshi-VariableItalic.ttf rel=preload type=font/ttf as=font crossorigin><link href=https://astro-theme-pure.vercel.app/blog/9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98 rel=canonical><meta content="9-虚拟内存 • Akiのink" name=title><meta content="对应 CSAPP 第九章节" name=description><meta content=Aki name=author><meta content="" name=theme-color><meta content=article property=og:type><meta content=9-虚拟内存 property=og:title><meta content="对应 CSAPP 第九章节" property=og:description><meta content=https://astro-theme-pure.vercel.app/blog/9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98 property=og:url><meta content=Akiのink property=og:site_name><meta content=en_US property=og:locale><meta content=https://astro-theme-pure.vercel.app/_astro/9.BzkR7uRL.png property=og:image><meta content=1200 property=og:image:width><meta content=630 property=og:image:height><meta content=Aki property=article:author><meta content=2023-02-18T09:00:00.000Z property=article:published_time><meta content=summary_large_image property=twitter:card><meta content=https://astro-theme-pure.vercel.app/blog/9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98 property=twitter:url><meta content=9-虚拟内存 property=twitter:title><meta content="对应 CSAPP 第九章节" property=twitter:description><meta content=https://astro-theme-pure.vercel.app/_astro/9.BzkR7uRL.png property=twitter:image><meta content=@cworld0_cn name=telegram:channel><link href=/sitemap-index.xml rel=sitemap><link href=https://astro-theme-pure.vercel.app/rss.xml rel=alternate type=application/rss+xml title=Akiのink><meta content="Astro v4.16.10" name=generator><link href=/styles/global.css rel=stylesheet><vercel-speed-insights data-params={&#34;slug&#34;:&#34;9-虚拟内存&#34;} data-pathname=/blog/9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98 data-props={}></vercel-speed-insights><script>console.log("%c Astro Theme Pure %c https://github.com/cworld1/astro-theme-pure/","color:#fff;background:linear-gradient(90deg,#448bff,#44e9ff);padding:5px 0;","color:#000;background:linear-gradient(90deg,#44e9ff,#ffffff);padding:5px 10px 5px 0px;")</script><link href=/_astro/_slug_.XaQ6XQsx.css rel=stylesheet><link href=/_astro/_slug_.BLJzc6jn.css rel=stylesheet><style>#waline[data-astro-cid-ksttp56e]{--waline-font-size:16px;--waline-white:hsl(var(--background) / var(--tw-bg-opacity));--waline-light-grey:#999;--waline-dark-grey:#666;--waline-theme-color:hsl(var(--foreground) / var(--tw-text-opacity));--waline-active-color:hsl(var(--primary) / var(--tw-text-opacity));--waline-color:hsl(var(--muted-foreground) / var(--tw-text-opacity));--waline-bg-color:hsl(var(--primary-foreground) / var(--tw-bg-opacity));--waline-bg-color-light:hsl(var(--input) / var(--tw-bg-opacity));--waline-bg-color-hover:#f0f0f0;--waline-border-color:hsl(var(--border) / var(--tw-border-opacity));--waline-disable-bg-color:#f8f8f8;--waline-disable-color:#bbb;--waline-code-bg-color:#282c34;--waline-bq-color:#f0f0f0;--waline-avatar-size:3.25rem;--waline-m-avatar-size:calc(var(--waline-avatar-size) * 9 / 13);--waline-badge-color:#3498db;--waline-badge-font-size:.775em;--waline-info-bg-color:var(--waline-bg-color-light);--waline-info-color:var(--waline-color);--waline-info-font-size:.625em;--waline-border:1px solid var(--waline-border-color);--waline-avatar-radius:50%;--waline-box-shadow:none}#waline[data-astro-cid-ksttp56e] .wl-reaction-title{display:none!important}#waline[data-astro-cid-ksttp56e] .wl-reaction{overflow:visible}#waline[data-astro-cid-ksttp56e] blockquote{position:relative;border-inline-start:4px solid transparent!important}#waline[data-astro-cid-ksttp56e] blockquote:before{content:"";height:100%;width:4px;left:-4px;top:0;position:absolute;border:2px solid var(--waline-bq-color)!important;border-radius:9999px}</style><link href=/_astro/_slug_.C639AhNv.css rel=stylesheet><script type=module src=/_astro/hoisted.B8nntUZK.js></script><script type=module src=/_astro/page.V2R8AmkL.js></script><script>window.va=window.va||function(){(window.vaq=window.vaq||[]).push(arguments)};var script=document.createElement("script");script.defer=!0,script.src="/_vercel/insights/script.js";var head=document.querySelector("head");head.appendChild(script)</script></head><body class="flex bg-background justify-center"><script>const lightModePref=window.matchMedia("(prefers-color-scheme: light)");function getUserPref(){return localStorage.getItem("theme")||(lightModePref.matches?"light":"dark")}function setTheme(e,t=!1){if(!["light","dark"].includes(e))return void console.log(`Invalid theme value '${e}' received. Expected 'light' or 'dark'.`);t&&localStorage.setItem("theme",e),document.documentElement.classList.toggle("dark","dark"===e);const r="dark"===e?"#0B0B10":"#FCFCFD";document.querySelector('meta[name="theme-color"]')?.setAttribute("content",r)}setTheme(getUserPref()),document.addEventListener("astro:after-swap",(()=>setTheme(getUserPref()))),document.addEventListener("theme-change",(e=>{const t=e.detail.theme;localStorage.setItem("theme",t),setTheme(e.detail.theme,!0)})),lightModePref.addEventListener("change",(e=>{setTheme(e.matches?"light":"dark")}))</script><main class="flex items-center flex-col leading-relaxed lg:px-10 max-w-[60rem] min-h-screen pb-10 px-4 sm:px-7 text-[0.92rem] w-screen z-10"><header-component class="transition-all py-1 border group [&#38;.not-top]:bg-background [&#38;.not-top]:border-border border-transparent box-content dark:[&#38;.not-top]:bg-primary-foreground duration-300 mb-16 rounded-xl sm:rounded-2xl sticky top-4 w-full z-30" data-astro-cid-qlfjksao><header class="flex flex-wrap sm:flex-nowrap sm:justify-start text-sm" data-astro-cid-qlfjksao><nav aria-label=global class="flex items-center justify-between mx-auto relative sm:flex sm:items-center w-full" data-astro-cid-qlfjksao><div class="hidden -left-4 -z-10 absolute box-content dark:max-sm:group-[.expanded]:bg-primary-foreground max-sm:group-[.expanded.not-top]:hidden max-sm:group-[.expanded]:block w-[calc(100%+2rem)] !duration-0 -top-8 h-20 max-sm:group-[.expanded]:bg-white" data-astro-cid-qlfjksao></div><a href=/ class="transition-all duration-300 flex-none font-semibold group-[.not-top]:ms-3 sm:group-[.not-top]:ms-5 text-xl" aria-label=Brand data-astro-cid-qlfjksao>Akiのink</a><div class="flex gap-x-4 sm:gap-x-6" data-astro-cid-qlfjksao><div class="transition-all duration-300 dark:group-[.expanded.not-top]:bg-primary-foreground end-0 grid group-[.expanded]:opacity-100 group-[.not-top]:rounded-xl max-md:border-b max-sm:absolute max-sm:group-[.expanded]:bg-background max-sm:group-[.not-top]:border max-sm:group-[.not-top]:pb-2 max-sm:group-[.not-top]:pt-2 max-sm:group-[.not-top]:px-4 max-sm:opacity-0 max-sm:pb-4 max-sm:pt-0 sm:border-0 sm:grid-rows-1 start-0 top-12 z-20" data-astro-cid-qlfjksao id=headerExpandConetent><div class="hidden -left-4 -z-10 absolute box-content dark:max-sm:group-[.expanded]:bg-primary-foreground max-sm:group-[.expanded.not-top]:hidden max-sm:group-[.expanded]:block w-[calc(100%+2rem)] bg-white h-full max-md:border-b top-0" data-astro-cid-qlfjksao></div><div class="flex items-center flex-col sm:flex-row gap-x-5 gap-y-2 justify-center overflow-hidden sm:gap-x-7 transition-colors" data-astro-cid-qlfjksao><a href=/blog class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>Blog </a><a href=/projects class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>Projects </a><a href=/links class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>Links </a><a href=/about class="w-full grow sm:w-fit flex-none font-medium hover:text-primary py-2 text-[1.05rem] text-right" aria-label="Nav Menu Item" data-astro-cid-qlfjksao>About</a><div class="flex flex-row gap-x-3 grow justify-end sm:gap-x-5 sm:w-fit w-full" data-astro-cid-qlfjksao><a href=https://www.travellings.cn/go.html class="px-1 py-2" data-astro-cid-qlfjksao title=Travelling><span class=sr-only data-astro-cid-qlfjksao>Travelling</span> <svg class=size-5 data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-train-2-line data-astro-cid-qlfjksao></use></svg> </a><a href=/search class="px-1 py-2" data-astro-cid-qlfjksao title=Search><span class=sr-only data-astro-cid-qlfjksao>Search</span> <svg class=size-5 data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-search-2-line data-astro-cid-qlfjksao></use></svg></a></div></div></div><div class="transition-all gap-x-4 flex group-[.not-top]:gap-x-2 group-[.not-top]:me-1.5" data-astro-cid-qlfjksao><button class="transition-all border hover:bg-border p-1.5 rounded-md sm:group-[.not-top]:rounded-xl group/dark" id=toggleDarkMode data-astro-cid-qlfjksao><span class=sr-only data-astro-cid-qlfjksao>Dark Theme</span> <svg class="transition-all group-hover/dark:text-primary size-5 dark:hidden" data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-sun-line data-astro-cid-qlfjksao></use></svg> <svg class="transition-all group-hover/dark:text-primary size-5 dark:block hidden" data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-moon-stars-line data-astro-cid-qlfjksao></use></svg></button> <button class="transition-all border hover:bg-border p-1.5 rounded-md sm:group-[.not-top]:rounded-xl sm:hidden" id=toggleMenu data-astro-cid-qlfjksao><span class=sr-only data-astro-cid-qlfjksao>Menu</span> <svg class=size-5 data-astro-cid-qlfjksao><use href=/icons/header.svg#mingcute-menu-line data-astro-cid-qlfjksao></use></svg></button></div></div></nav></header></header-component><div class=w-full data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><a href=/blog class="transition-all py-1 border group bg-primary-foreground border-border gap-x-1 hover:bg-input inline-flex items-center no-underline px-2 rounded-lg text-muted-foreground text-sm" data-astro-cid-bvzihdzo data-astro-prefetch><svg class="group-hover:stroke-primary stroke-muted-foreground" fill=none height=16 stroke-linecap=round stroke-linejoin=round stroke-width=2.5 viewBox="0 0 24 24" width=16 xmlns=http://www.w3.org/2000/svg><line class="transition-all duration-300 ease-in-out group-hover:scale-x-100 scale-x-0 group-hover:translate-x-0 translate-x-3" x1=19 x2=5 y1=12 y2=12></line><polyline class="transition-all duration-300 ease-in-out group-hover:translate-x-0 translate-x-1" points="12 19 5 12 12 5"></polyline></svg><p class=my-0>Back</p></a><div class="gap-x-10 lg:flex lg:items-start mt-8" data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><aside class="animate -me-24 basis-60 max-lg:hidden order-2 sticky top-[15%]"><toc-heading><h2 class=font-semibold>TABLE OF CONTENTS</h2><ul class="max-h-[70vh] mt-4 overflow-y-scroll text-card-foreground"><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#九虚拟内存 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75" aria-label="Scroll to section: 九、虚拟内存">九、虚拟内存</a></div><ul><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#91-物理和虚拟寻址 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.1 物理和虚拟寻址">9.1 物理和虚拟寻址</a></div><ul><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#92-地址空间 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.2 地址空间">9.2 地址空间</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#93-虚拟内存作为缓存的工具 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.3 虚拟内存作为缓存的工具">9.3 虚拟内存作为缓存的工具</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#94-虚拟内存作为内存管理的工具 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.4 虚拟内存作为内存管理的工具">9.4 虚拟内存作为内存管理的工具</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#95-虚拟内存作为内存保护的工具 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.5 虚拟内存作为内存保护的工具">9.5 虚拟内存作为内存保护的工具</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#96-地址翻译 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.6 地址翻译">9.6 地址翻译</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#97-intel-core-i7linux-内存系统 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.7 Intel Core i7/Linux 内存系统">9.7 Intel Core i7/Linux 内存系统</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#98-内存映射 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.8 内存映射">9.8 内存映射</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#99-动态内存分配 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.9 动态内存分配">9.9 动态内存分配</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#910-垃圾收集 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.10 垃圾收集">9.10 垃圾收集</a></div></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#911-c程序中与内存有关的错误 class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: 9.11 C程序中与内存有关的错误">9.11 C程序中与内存有关的错误</a></div></li></ul></li><li><div class=relative><span class="duration-300 absolute [&.highlight-bg]:bg-primary [&.readed]:bg-input rounded top-[5%] transition-colors w-[2px]"></span> <a href=#lab class="transition-all py-1 [&#38;.highlight-bg-translucent]:bg-primary-foreground [&#38;.highlight]:font-medium [&#38;.highlight]:text-primary [&#38;.readed]:text-input flex-1 hover:text-foreground line-clamp-2 ms-2 px-3 text-foreground/75 ps-7" aria-label="Scroll to section: LAB:">LAB:</a></div></li></ul></li></ul></toc-heading></aside><article class="break-words flex-grow" data-astro-cid-bvzihdzo data-pagefind-body style="flex-grow:3;flex-shrink:1;flex-basis:60%;--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><div data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))" id=blog-hero><div class="relative animate hero-image max-lg:mx-auto mb-6 prose"><img alt=9-虚拟内存 decoding=async height=1106 loading=eager src=/_astro/9.BzkR7uRL_27ddqA.webp width=1958 class="relative w-full cover-image h-auto object-contain rounded-2xl z-10" fetchpriority=high inferSize=true><img alt=9-虚拟内存 decoding=async height=1106 loading=eager src=/_astro/9.BzkR7uRL_27ddqA.webp width=1958 class="duration-300 absolute blur-xl h-full mt-0 opacity-40 start-0 top-4 transition-opacity w-full z-0" fetchpriority=high inferSize=true id=blurImage></div><div class="animate max-lg:mx-auto article-info max-w-[65ch]"><div class="flex flex-wrap gap-x-4 gap-y-2 leading-6 text-muted-foreground text-xs"><div class="flex items-center gap-1"><svg class=size-5><use href=/icons/ui.svg#mingcute-calendar-2-line></use></svg> <samp class=text-muted-foreground><time datetime=2023-02-18T09:00:00.000Z>Feb 18, 2023</time></samp></div><div class="flex items-center gap-1"><svg class=size-5><use href=/icons/ui.svg#mingcute-time-line></use></svg> 14 min read</div><span class="flex items-center gap-1"><svg class=size-5><use href=/icons/project.svg#mingcute-earth-2-line></use></svg> 中文</span></div><h1 class="font-medium mt-4 sm:mb-2 sm:mt-6 sm:text-3xl text-2xl">9-虚拟内存</h1><div class="flex items-center flex-row flex-wrap gap-x-1 mt-3 sm:mt-5"><svg class=size-5><use href=/icons/ui.svg#mingcute-tag-line></use></svg><div><a href=/tags/csapp class="before:content-['#'] hover:underline hover:underline-offset-4 inline-block" aria-label="View more blogs with the tag csapp" data-pagefind-filter=tag>csapp</a></div></div><div class="mt-3 italic"><blockquote class="text-muted-foreground text-sm"><q>对应 CSAPP 第九章节</q></blockquote><div class="text-muted-foreground text-sm mt-1"><span class=waline-pageview-count data-path=/blog/9-虚拟内存></span> views | <span class=waline-comment-count data-path=/blog/9-虚拟内存></span> comments</div></div></div><div class="sm:mt-6 mt-4 border-t max-lg:mx-auto sm:w-1/3 w-1/2"></div></div><div class="text-muted-foreground dark:prose-invert mt-8 prose prose-base prose-headings:before:-ms-4 prose-headings:before:absolute prose-headings:font-medium prose-headings:text-foreground prose-th:before:content-none prose-zinc animate max-lg:mx-auto" data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))" id=content><h1 id=ics><a href=https://aki-yzh.github.io/2023/02/18/1-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8&#x26;%E7%9B%AE%E5%BD%95 target=_blank rel="nofollow, noopener, noreferrer">ICS</a></h1><hr><h2 id=九虚拟内存>九、虚拟内存</h2><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 虚拟内存是硬件异常，硬件地址翻译，主存，磁盘文件和内核软件的完美交互，它为每个进程提供了一个大的，一致的和私有的地址空间。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 虚拟内存提供了三个重要能力：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 1. 它将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，高效地使用了主存。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 2. 它为每个进程提供了一致的地址空间，从而简化了内存管理</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 3. 它保护了每个进程的地址空间不被其他进程破坏</p><h4 id=91-物理和虚拟寻址>9.1 物理和虚拟寻址</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 主存被组织成一个由M个连续的字节大小的单元组成的数组，每个字节都有一个唯一的物理地址。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> CPU访问内存的最自然的方式就是使用物理地址，我们把这种方式称为物理寻址。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 使用虚拟寻址，CPU通过生成一个虚拟地址来访问主存，这个虚拟地址在被传送到内存之前先转换成适当的物理地址。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 将一个虚拟地址转换为物理地址的任务叫做地址翻译，CPU上叫做内存管理单元的专用硬件利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。</p><h4 id=92-地址空间>9.2 地址空间</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 地址空间是一个非负整数地址的有序集合。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 线性地址空间：地址空间中整数是连续的</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 虚拟地址空间(N=2^n)（n位地址空间）</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 物理地址空间(M=2^m)</p><h4 id=93-虚拟内存作为缓存的工具>9.3 虚拟内存作为缓存的工具</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的单元组成的数组，每个字节有唯一的虚拟地址，作为到数组的索引。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 磁盘上数组的内容被缓存在主页中。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> VM系统通过将虚拟内存分割为称为虚拟页的大小固定的块来处理这个问题。每个虚拟页的大小为<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>P</mi><mo>=</mo><msup><mn>2</mn><mi>p</mi></msup></mrow><annotation encoding=application/x-tex>P=2^p</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.13889em>P</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6644em></span><span class=mord><span class=mord>2</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.6644em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span> 个字节。类似的，物理内存被分配为物理页，大小也为P字节。（物理页也被称为页帧）</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 在任意时刻，虚拟页面的集合都分为三个不相交的子集：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 1. 未分配的：VM还未分配（或者创建）的页。没有任何数据与之相关联，因此也不占用任何磁盘空间</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 2. 缓存的：已缓存在物理内存中的已分配页</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 3. 未缓存的： 未缓存在物理内存中的已分配页</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> DRAM缓存（虚拟内存系统的缓存）：虚拟页往往很大，全相联，总是使用写回</p><p><strong>页表</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 页表存放在物理内存中，将虚拟页映射到物理页。每次地址翻译硬件将一个虚拟地址转化为物理地址时，都会读取页表。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 页表就是个页表条目(PTE)的数组，每个PTE是由一个有效位和一个n位地址字段组成的。</p><img alt="" decoding=async height=652 loading=lazy src=/_astro/20230215212321.B8Imvvbx_Z22jrxT.webp width=926><p><strong>页命中</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 虚拟地址->索引->有效位1->物理地址</p><img alt="" decoding=async height=682 loading=lazy src=/_astro/20230215212633.CP7gQ_Y7_1G3N8I.webp width=1058><p><strong>缺页</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> DRAM缓存不命中->调用内核中的异常处理程序->页面调度（按需页面调度）</p><img alt="" decoding=async height=1318 loading=lazy src=/_astro/20230215213456.B1kH1RjT_oPLzV.webp width=1300><p><strong>分配页面</strong></p><img alt="" decoding=async height=806 loading=lazy src=/_astro/20230215212920.CvdudzFp_ZesI4N.webp width=866><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 局部性保证了任意时刻程序趋向于在一个较小的活动页面集合上工作</p><h4 id=94-虚拟内存作为内存管理的工具>9.4 虚拟内存作为内存管理的工具</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 按需页面调度+独立地址空间=简化链接、简化加载、简化共享、简化内存分配</p><h4 id=95-虚拟内存作为内存保护的工具>9.5 虚拟内存作为内存保护的工具</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 三个许可位：SUP，READ，WRITE表示权限</p><h4 id=96-地址翻译>9.6 地址翻译</h4><img alt="" decoding=async height=920 loading=lazy src=/_astro/20230215213421.D-pBLYjE_Z27YOXF.webp width=986><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 形式上来说，地址翻译是一个N元素的虚拟地址空间中的元素（VAS）和一个M元素的物理地址空间（PAS）中元素之间的映射</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace><mspace width=2em></mspace><mspace width=1em></mspace><mi>M</mi><mi>A</mi><mi>P</mi><mo>:</mo><mi>V</mi><mi>A</mi><mi>S</mi><mo>→</mo><mi>P</mi><mi>A</mi><mi>S</mi><mo>∪</mo><mi mathvariant=normal>∅</mi></mrow><annotation encoding=application/x-tex>\qquad \qquad \quad MAP:VAS\rightarrow PAS \cup \emptyset</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class=mspace style=margin-right:2em></span><span class=mspace style=margin-right:2em></span><span class=mspace style=margin-right:1em></span><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style=margin-right:.13889em>P</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.22222em>V</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style=margin-right:.05764em>S</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>→</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.13889em>P</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style=margin-right:.05764em>S</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>∪</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8056em;vertical-align:-.0556em></span><span class=mord>∅</span></span></span></span></p><img alt="" decoding=async height=116 loading=lazy src=/_astro/20230215214022.D6zU3waS_Z2kOX7e.webp width=1220><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> PPO和VPO是相同的</p><img alt="" decoding=async height=528 loading=lazy src=/_astro/20230215214156.BlDgm31I_1ydeNy.webp width=980><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 页面命中后，CPU硬件：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 1. 处理器生成一个虚拟地址，并把它传给MMU</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 2. MMU生成PTE地址，并从高速缓存/主存中请求得到它</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 3. 高速缓存/主存向MMU返回PTE</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 4. MMU构造物理地址，并把它传送给高速缓存/主存</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 5. 高速缓存/主存返回所请求的数据字给处理器</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 缺页时：</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 1. 处理器生成一个虚拟地址，并把它传给MMU</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 2. MMU生成PTE地址，并从高速缓存/主存中请求得到它</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 3. 高速缓存/主存向MMU返回PTE</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 4. PTE的有效位是0，MMU触发了一次异常，传递CPU中的控制到操作系统内核中的缺页异常处理程序</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 5. 缺页处理程序确定出物理内存中的牺牲页，如果这个页面已经被修改了，则把它换出到磁盘</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 6. 缺页处理程序调入新的页面，并更新内存中的PTE</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=2em></mspace></mrow><annotation encoding=application/x-tex>\qquad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:2em></span></span></span></span> 7. 缺页处理程序返回到原来的进程，再次执行导致缺页的指令。CPU将引起缺页的虚拟地址重新发送给MMU。因为虚拟页面现在换存在物理内存中，所以就会命中，在MMU执行了页面命中后，主存将所请求字返回给处理器。</p><p><img alt="" decoding=async height=1170 loading=lazy src=/_astro/20230215214326.CeuRLijP_pyp5y.webp width=1464> <strong>结合高速缓存和虚拟内存</strong> <img alt="" decoding=async height=608 loading=lazy src=/_astro/20230215215737.D12ERfCz_RbpWl.webp width=1552> <strong>利用TLB加速地址翻译</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> TLB：小的，虚拟寻址的缓存，称为快表，每一行保存着一个由单个PTE组成的块。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 若TLB有2^t个组，则VPN最低t位为TLB索引（TLBI）</p><img alt="" decoding=async height=172 loading=lazy src=/_astro/20230215220155.CeTGVJWB_Z2lgvi.webp width=778><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 1. CPU产生一个虚拟地址</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 2. MMU从TLB中取出相应的PTE</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 3. MMU将这个虚拟地址翻译成一个物理地址，并且将它发送到高速缓存/主存。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 4. 高速缓存/主存将所请求的数据字返回给CPU <img alt="" decoding=async height=720 loading=lazy src=/_astro/20230215215804.D1jBGjaj_Z21dUhn.webp width=1558> <strong>多级页表</strong></p><img alt="" decoding=async height=852 loading=lazy src=/_astro/20230215220457.CxK5IUS__Z1fWhJ0.webp width=1318><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 每个高级PTE指向一个下一级页表的基址，逐级访问直到最终访问到目标地址，只有一级页表才需要总是保存在主存中。</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 能减小内存要求</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 若一级页表中一个PTE是空的，相应的二级页表根本不会存在 <img alt="" decoding=async height=446 loading=lazy src=/_astro/20230215220429.COJCsza4_Z1HstzW.webp width=698></p><h4 id=97-intel-core-i7linux-内存系统>9.7 Intel Core i7/Linux 内存系统</h4><p><strong>Intel Core i7</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 四级页表层次结构，64位内存地址，40位PPN，4个许可位，1个标记位，引用位(A)，修改位(D) <strong>Linux虚拟内存系统</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 基本同上述虚拟内存系统</p><h4 id=98-内存映射>9.8 内存映射</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 将一个虚拟内存区域与一个磁盘上的对象关联起来，以初始化这个虚拟内存区域的内容</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 映射对象：普通文件和匿名文件</p><p><strong>共享对象&#x26;私有对象</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 映射了同一个共享对象的各进程对这个对象的写是相互可见的，也会反映到磁盘上的原始对象中</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 对私有区域的写操作不会反映到磁盘上的对象中</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 写时复制：试图写时会触发保护故障，创建一个新的副本（写操作仅执行在该副本上，且其他进程不可见） <img alt="" decoding=async height=304 loading=lazy src=/_astro/20230215224447.BzeOqRn8_D6Uak.webp width=414> <strong>再看fork</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 为新进程创建各种数据结构，PID</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 两个进程的每个页面都标记为只读</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 每个区域结构都标记为私有的写时复制</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 为每个进程维护私有地址空间的抽象概念</p><p><strong>再看execve</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 删除已存在的用户区域</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 映射私有区域（都是私有的，写时复制的）</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 映射共享区域</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 设置程序计数器(PC)，指向代码区域入口</p><p><strong>mmap与munmap：用户级内存映射</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> mmap：创建新的虚拟内存区域，并将对象映射到这些区域中</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>mmap</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>start</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>size_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> length</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> prot</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> flags</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#e36209;--shiki-dark:#FFAB70> fd</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>off_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> offfset</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>//成功返回指向映射区域的指针，出错返回MAP——FAILED（-1）</span></span>
<span class=line></span></code></pre><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> prot：访问权限位：PROT_EXEC（页面可以被CPU执行的指令组成）；PROT_READ（页面可读）；PROT_WRITE（页面可写）；PROT_NONE（页面不能被访问） <img alt="" decoding=async height=606 loading=lazy src=/_astro/20230215224830.CN-4neqU_Z1AbcmI.webp width=982></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> munmap：删除虚拟内存的start开始由接下来length字节构成的区域</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>int</span><span style=color:#6f42c1;--shiki-dark:#B392F0> munmap</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>start</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#d73a49;--shiki-dark:#F97583>size_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> length</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>//成功返回0，出错返回-1</span></span>
<span class=line></span></code></pre><h4 id=99-动态内存分配>9.9 动态内存分配</h4><img alt="" decoding=async height=844 loading=lazy src=/_astro/20230215225518.BwJzPjhr_xnG6q.webp width=584><p><strong>显示分配器</strong>：显式地释放已分配的块</p><pre class="astro-code astro-code-themes github-dark github-light" data-language=cpp style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 分配块 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>malloc</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>size_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> size</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span><span style=color:#6a737d;--shiki-dark:#6A737D>//成功返回已分配块的指针，否则NULL</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 释放块 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#6f42c1;--shiki-dark:#B392F0> free</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#e36209;--shiki-dark:#FFAB70>ptr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>/* 扩展/收缩堆 */</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>void</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#6f42c1;--shiki-dark:#B392F0>sbrk</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>intptr_t</span><span style=color:#e36209;--shiki-dark:#FFAB70> incr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>);</span></span>
<span class=line></span></code></pre><p>要求</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 处理任意请求序列：约束：每个释放必须对应一个已分配的块</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 立即响应请求：不允许重排或缓冲</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 只使用堆</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 对齐块：对齐块使得能保存任何类型的数据对象</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 不修改已分配的块 目标</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 最大化吞吐率</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 吞吐率：单位时间完成的请求数</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 最大化内存利用率</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 峰值利用率：聚集有效载荷/堆大小</p><img alt="" decoding=async height=94 loading=lazy src=/_astro/20230215225953.bvk0a8gi_1j5VzW.webp width=302><p><strong>碎片</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 内部碎片：已分配块比有效载荷大</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 外部碎片：空闲内存分散</p><p><strong>隐式空闲链表</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 整个链表需要一个特殊标记的结束块</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 空闲块之间通过头部的块大小隐式地连接</p><img alt="" decoding=async height=380 loading=lazy src=/_astro/20230215230110.Cb1IZwUC_ZH5qfR.webp width=650><p>放置已分配的块</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 首次适配</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 下一次适配（内存利用率最低）</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 最佳适配（内存利用率最高） 分割空闲块</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 获取额外堆内存</p><p>合并空闲块</p><p>立即合并</p><p>推迟合并</p><p>带边界标记的合并（脚部）</p><img alt="" decoding=async height=386 loading=lazy src=/_astro/20230215230135.BdElg5qO_2YxUA.webp width=356><p><strong>显式空闲链表</strong></p><img alt="" decoding=async height=408 loading=lazy src=/_astro/20230215230249.c0PKfmwM_ZSexoQ.webp width=870><p><strong>分离空闲链表</strong></p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 维护多个空闲链表，每个链表中的块有相似的大小</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 简单分离存储：一个类中所有块大小都一样，不分割不合并</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 分离适配：首次适配，分割，释放后合并</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 伙伴系统：按2的幂进行分配、分割、合并</p><p>详见malloclab</p><h4 id=910-垃圾收集>9.10 垃圾收集</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 垃圾收集器：动态内存分配器</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 自动释放程序不再需要的已分配块</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 内存视为有向可达图，不可达节点->垃圾</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> Mark&#x26;Sweep垃圾收集器</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> Mark阶段：标记根节点和所有可达的后继</p><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> Sweep阶段：释放每个未标记的已分配块</p><h4 id=911-c程序中与内存有关的错误>9.11 C程序中与内存有关的错误</h4><p><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mspace width=1em></mspace></mrow><annotation encoding=application/x-tex>\quad</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0></span><span class=mspace style=margin-right:1em></span></span></span></span> 间接引用坏指针、读未初始化的内存、允许栈缓冲区溢出、造成错位错误、假设指针和它们指向的对象是相同大小的、引用指针而不是它所指向的对象、误解指针运算、引用不存在的变量、引用空闲堆块中的数据、引起内存泄漏……</p><hr><h3 id=lab>LAB:</h3><p><strong>此章节后完成<a href=https://github.com/Aki-yzh/PKU-ICS-2022/tree/main/LABS/7-malloclab target=_blank rel="nofollow, noopener, noreferrer">malloclab(103.0/120.0)</a></strong></p></div></article></div><div class="text-muted-foreground dark:prose-invert mt-8 prose prose-base prose-headings:before:-ms-4 prose-headings:before:absolute prose-headings:font-medium prose-headings:text-foreground prose-th:before:content-none prose-zinc" data-astro-cid-bvzihdzo style="--primaryColor:hsl(var(--primary) / var(--tw-text-opacity))"><div class="flex flex-col gap-y-2 border px-3 py-2 relative rounded-xl sm:px-4 sm:py-3"><svg class="opacity-10 absolute end-4 size-20 top-4"><use href=/icons/copyright-sponsor.svg#mingcute-copyright-line></use></svg><div class="flex flex-col"><div class=text-foreground>9-虚拟内存</div><div class=text-sm>https://astro-theme-pure.vercel.app/blog/9-虚拟内存</div></div><div class="flex flex-row flex-wrap gap-x-5 gap-y-1 justify-start sm:gap-x-8"><div class="flex gap-x-2 sm:flex-col"><span class=text-foreground>Author</span> <span class="text-sm max-sm:place-self-center">Aki</span></div><div class="flex gap-x-2 sm:flex-col sm:min-w-16"><span class=text-foreground>Update date</span> <span class="text-sm max-sm:place-self-center">February 18, 2023</span></div><div class="flex gap-x-2 sm:flex-col"><span class=text-foreground>Copyright</span> <a href=https://creativecommons.org/licenses/by/4.0/ class="text-muted-foreground text-sm max-sm:place-self-center" target=_blank>CC BY-NC-SA 4.0</a></div></div><div class=relative><div class="flex flex-row gap-3"><button class="transition-colors group bg-primary-foreground hover:text-primary p-1 rounded-full sm:p-1.5 text-muted-foreground" id=copy-link><svg class=size-5><use href=/icons/copyright-sponsor.svg#mingcute-link-2-line></use></svg></button><button class="transition-colors group bg-primary-foreground hover:text-primary p-1 rounded-full sm:p-1.5 text-muted-foreground" id=get-qrcode><svg class=size-5><use href=/icons/copyright-sponsor.svg#mingcute-qrcode-2-line></use></svg></button><button class="transition-colors group bg-primary-foreground hover:text-primary p-1 rounded-full sm:p-1.5 text-muted-foreground" id=share-weibo><svg class=size-5><use href=/icons/copyright-sponsor.svg#mingcute-weibo-line></use></svg></button></div><div class="transition-all duration-300 ease-in-out *:my-0 -mt-2 absolute aria-expanded:max-h-[256px] aria-expanded:opacity-100 aria-expanded:translate-y-4 bg-primary-foreground border box-content max-h-0 opacity-0 overflow-hidden p-4 rounded-xl z-10" id=qrcode aria-expanded=false></div></div></div><div class="border-t-0 border mx-6 pb-1.5 pt-1 px-3 rounded-b-xl sm:mx-8 sm:px-4"><a href=/projects#sponsorship class="flex justify-between no-underline text-muted-foreground" target=_blank><div>Buy me a cup of coffee ☕.</div><svg class="size-5 m-1"><use href=/icons/copyright-sponsor.svg#mingcute-receive-money-line></use></svg></a></div><script type=module>import QRCode from"/scripts/qrcode.js";const link=window.location.href,copyLink=document.getElementById("copy-link");function loadqrcode(e){if(!e)throw new Error("qrcode container not found");""===e.innerHTML&&new QRCode(e,link)}copyLink?.addEventListener("click",(()=>{navigator.clipboard.writeText(link)}));const getQRCode=document.getElementById("get-qrcode"),qrcodeContainer=document.getElementById("qrcode");if(!qrcodeContainer)throw new Error("qrcode container not found");getQRCode?.addEventListener("click",(()=>{"true"===qrcodeContainer.ariaExpanded?qrcodeContainer.ariaExpanded="false":(loadqrcode(qrcodeContainer),qrcodeContainer.ariaExpanded="true")}));const shareWeibo=document.getElementById("share-weibo");shareWeibo?.addEventListener("click",(()=>{const e=`http://service.weibo.com/share/share.php?url=${link}&title=${document.title}&pic=https://cravatar.cn/avatar/1ffe42aa45a6b1444a786b1f32dfa8aa?s=400`;window.open(e,"_blank")}))</script><div class="mt-3 sm:mt-6 gap-2 grid grid-cols-1 sm:gap-4 sm:grid-cols-2"><a href=/blog/10-系统级io class="flex items-center border-transparent duration-300 group border gap-3 hover:bg-primary-foreground no-underline px-4 py-2 rounded-lg sm:py-4 transition-colors"><svg class="transition-colors group-hover:stroke-primary stroke-muted-foreground rotate-180" fill=none height=20 stroke-linecap=round stroke-linejoin=round stroke-width=2.5 viewBox="0 0 24 24" width=20 xmlns=http://www.w3.org/2000/svg><line class="transition-all duration-300 ease-in-out group-hover:translate-x-1 group-hover:scale-x-100 scale-x-0 translate-x-4" x1=5 x2=19 y1=12 y2=12></line><polyline class="transition-all duration-300 ease-in-out group-hover:translate-x-1 translate-x-0" points="12 5 19 12 12 19"></polyline></svg><div class="flex flex-col gap-0.5 grow max-w-[80%] sm:gap-1.5"><div class="text-muted-foreground text-sm font-normal uppercase">Prev</div><div class="transition-colors font-medium truncate whitespace-nowrap">10-系统级IO</div></div></a><a href=/blog/8-异常控制流 class="flex items-center border-transparent duration-300 group border gap-3 hover:bg-primary-foreground no-underline px-4 py-2 rounded-lg sm:py-4 transition-colors justify-end text-right"><div class="flex flex-col gap-0.5 grow max-w-[80%] sm:gap-1.5"><div class="text-muted-foreground text-sm font-normal uppercase">Next</div><div class="transition-colors font-medium truncate whitespace-nowrap">8-异常控制流</div></div><svg class="transition-colors group-hover:stroke-primary stroke-muted-foreground" fill=none height=20 stroke-linecap=round stroke-linejoin=round stroke-width=2.5 viewBox="0 0 24 24" width=20 xmlns=http://www.w3.org/2000/svg><line class="transition-all duration-300 ease-in-out group-hover:translate-x-1 group-hover:scale-x-100 scale-x-0 translate-x-4" x1=5 x2=19 y1=12 y2=12></line><polyline class="transition-all duration-300 ease-in-out group-hover:translate-x-1 translate-x-0" points="12 5 19 12 12 19"></polyline></svg></a></div><comment-component data-astro-cid-ksttp56e><div class="mt-3 sm:mt-6 not-prose" id=waline data-astro-cid-ksttp56e>Comment seems to stuck. Try to refresh?✨</div></comment-component></div><button class="transition-all duration-300 bg-primary-foreground opacity-0 border-2 border-transparent bottom-8 data-[show=true]:opacity-100 data-[show=true]:translate-y-0 end-4 fixed flex group h-10 hover:border-border/75 items-center justify-center rounded-full sm:end-8 sm:h-12 sm:w-12 text-muted-foreground translate-y-28 w-10 z-90" id=to-top-btn aria-label="Back to Top" data-show=false><div class="flex items-center justify-center absolute bottom-0 end-0 group-[.ended]:opacity-0 group-hover:opacity-0 start-0 top-0 transition-opacity"><span class=text>10</span> <span class=text-xs>%</span></div><svg class="size-6 group-[.ended]:opacity-100 group-hover:opacity-100 opacity-0 transition-opacity"><use href=/icons/ui.svg#mingcute-up-line></use></svg></button><script>!function(){const e=document.getElementById("to-top-btn"),t=e.children[0].children[0],n=document.getElementById("blog-hero"),o=document.getElementById("content");e.addEventListener("click",(()=>{document.documentElement.scrollTo({behavior:"smooth",top:0})}));new IntersectionObserver((function(t){t.forEach((t=>{e.dataset.show=(!t.isIntersecting).toString()}))})).observe(n);{const n=o.scrollHeight,c=o.offsetTop,d=document.documentElement.clientHeight;document.addEventListener("scroll",(()=>{const o=function(){var e=document.documentElement.scrollTop||document.body.scrollTop;if(!(e<c))return Math.round((e-c)/(n-d)*100)}();void 0!==o&&(t.innerText=o.toString(),e.classList.toggle("ended",o>100))}))}}()</script></div><footer class="w-full mx-auto mt-24"><div class="border-t border-border pt-5"><div class="flex items-center flex-col sm:flex-row gap-y-3 sm:flex sm:gap-y-0 sm:items-center sm:justify-between"><div class="flex items-center flex-col sm:flex-row gap-2 sm:gap-x-4 text-sm"><p class="">© <samp>2024</samp> Aki. All rights reserved.</p></div><div class="flex items-center justify-between"><div class="flex items-center gap-x-4"><a href=https://github.com/Aki-yzh class="transition-all text-muted-foreground hover:text-muted-foreground/75 inline-block" aria-label=github><svg class=size-6><use href=/icons/social.svg#mingcute-github-line></use></svg> </a><a href=/rss.xml class="transition-all text-muted-foreground hover:text-muted-foreground/75 inline-block" aria-label=rss><svg class=size-6><use href=/icons/social.svg#mingcute-rss-2-line></use></svg></a></div></div></div></div></footer></main></body></html>